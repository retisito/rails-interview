<!-- Turbo Stream Connection -->
<% if @session_id %>
  <%= turbo_stream_from "progress_#{@session_id}" %>
<% end %>

<!-- Simple Progress Controller Container -->
<div data-controller="simple-progress" 
     data-simple-progress-url-value="<%= start_progressive_completion_todo_list_path(@todo_list) %>"
     data-simple-progress-pending-count-value="<%= @todo_items.pending.count %>">

<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="h2">
      <i class="bi bi-folder text-primary me-2"></i>
      <%= @todo_list.name %>
    </h1>
    <p class="text-muted mb-0">
      <i class="bi bi-calendar me-1"></i>
      Creada el <%= @todo_list.created_at.strftime("%d/%m/%Y a las %H:%M") %>
    </p>
  </div>
  <div>
    <%= link_to edit_todo_list_path(@todo_list), class: "btn btn-outline-secondary me-2" do %>
      <i class="bi bi-pencil me-1"></i>Editar Lista
    <% end %>
    <%= link_to todo_lists_path, class: "btn btn-secondary" do %>
      <i class="bi bi-arrow-left me-1"></i>Volver
    <% end %>
  </div>
</div>

<!-- Progress Bar Container (Controlado por Stimulus) -->
<div id="progress-container" 
     class="mb-4" 
     data-progress-target="container"
     style="display: none;">
  <%= render "shared/progress_bar", 
      percentage: 0,
      message: "Presiona 'Iniciar Procesamiento' para comenzar", 
      current_item: 0,
      total_items: @todo_items.pending.count,
      status: 'waiting' %>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
  <div class="col-md-4">
    <div class="card text-center bg-primary text-white">
      <div class="card-body">
        <i class="bi bi-list-task display-4"></i>
        <h5 class="card-title mt-2"><%= @todo_items.count %></h5>
        <p class="card-text">Total de Tareas</p>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card text-center bg-success text-white">
      <div class="card-body">
        <i class="bi bi-check-circle display-4"></i>
        <h5 class="card-title mt-2"><%= @todo_items.completed.count %></h5>
        <p class="card-text">Completadas</p>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card text-center bg-warning text-white">
      <div class="card-body">
        <i class="bi bi-clock display-4"></i>
        <h5 class="card-title mt-2"><%= @todo_items.pending.count %></h5>
        <p class="card-text">Pendientes</p>
      </div>
    </div>
  </div>
</div>

<!-- Progressive Completion with Hotwire -->
<% if @todo_items.pending.any? %>
<div class="card mb-4 border-success">
  <div class="card-header bg-success text-white">
    <h5 class="mb-0">
      <i class="bi bi-cpu me-2"></i>
      Procesamiento de Alta Carga (Hotwire)
    </h5>
  </div>
  <div class="card-body">
    <div class="row align-items-center">
      <div class="col-md-8">
        <p class="card-text mb-2">
          <i class="bi bi-lightning-charge me-1"></i>
          <strong>Nuevo:</strong> Simulaci√≥n de proceso intensivo con barra de progreso en tiempo real usando Hotwire.
        </p>
        <small class="text-muted">
          ‚ö° Turbo Streams + Stimulus + Active Jobs + Redis
        </small>
      </div>
      <div class="col-md-4">
        <button data-simple-progress-target="button"
                data-action="click->simple-progress#start"
                class="btn btn-success w-100 btn-lg">
          <i class="bi bi-play-circle-fill me-2"></i>
          Iniciar Procesamiento
        </button>
      </div>
    </div>
  </div>
</div>
<% end %>



<!-- Auto-Complete Actions -->
<% if @todo_items.pending.any? %>
<div class="card mb-4 border-info">
  <div class="card-header bg-info text-white">
    <h5 class="mb-0">
      <i class="bi bi-magic me-2"></i>
      Completado Autom√°tico (Simple)
    </h5>
  </div>
  <div class="card-body">
    <p class="card-text">
      <i class="bi bi-robot me-1"></i>
      Simula un proceso autom√°tico que completa todas las tareas pendientes con delay.
    </p>
    <div class="row g-2">
      <div class="col-md-4">
        <%= button_to "üöÄ Completar R√°pido (5s)", 
            "#", 
            method: :post,
            class: "btn btn-info w-100",
            onclick: "scheduleAutoComplete('simple', 5); return false;" %>
      </div>
      <div class="col-md-4">
        <%= button_to "‚è∞ Completar Lento (15s)", 
            "#", 
            method: :post,
            class: "btn btn-warning w-100",
            onclick: "scheduleAutoComplete('simple', 15); return false;" %>
      </div>
      <div class="col-md-4">
        <%= button_to "üé≤ Completar Aleatorio", 
            "#", 
            method: :post,
            class: "btn btn-secondary w-100",
            onclick: "scheduleAutoComplete('random'); return false;" %>
      </div>
    </div>
    <div class="row g-2 mt-2">
      <div class="col-md-6">
        <%= button_to "üì¶ Completar por Lotes", 
            "#", 
            method: :post,
            class: "btn btn-success w-100",
            onclick: "scheduleAutoComplete('batch'); return false;" %>
      </div>
      <div class="col-md-6">
        <%= link_to "/sidekiq", 
            target: "_blank",
            class: "btn btn-outline-dark w-100" do %>
          <i class="bi bi-speedometer2 me-1"></i>Monitor Jobs
        <% end %>
      </div>
    </div>
  </div>
</div>
<% end %>

<!-- Add New Task -->
<div class="card mb-4">
  <div class="card-header bg-light">
    <h5 class="mb-0">
      <i class="bi bi-plus-circle me-2"></i>
      Agregar Nueva Tarea
    </h5>
  </div>
  <div class="card-body">
    <%= form_with model: [@todo_list, @todo_list.todo_items.build], local: true, class: "row g-3" do |form| %>
      <div class="col-md-8">
        <%= form.text_field :description, 
            placeholder: "Describe tu nueva tarea...", 
            class: "form-control", 
            required: true %>
      </div>
      <div class="col-md-4">
        <%= form.submit "Agregar Tarea", class: "btn btn-primary w-100" %>
      </div>
    <% end %>
  </div>
</div>

<!-- Todo Items List -->
<div class="card">
  <div class="card-header">
    <h5 class="mb-0">
      <i class="bi bi-list-ul me-2"></i>
      Tareas (<%= @todo_items.count %>)
    </h5>
  </div>
  <div class="card-body p-0">
    <% if @todo_items.any? %>
      <div class="list-group list-group-flush">
        <% @todo_items.each do |todo_item| %>
          <%= render "todo_item", todo_item: todo_item, todo_list: @todo_list %>
        <% end %>
      </div>
    <% else %>
      <div class="text-center py-5">
        <i class="bi bi-inbox display-4 text-muted"></i>
        <h5 class="mt-3 text-muted">No hay tareas en esta lista</h5>
        <p class="text-muted">Agrega tu primera tarea usando el formulario de arriba</p>
      </div>
    <% end %>
  </div>
</div>

</div> <!-- Cerrar Progress Controller Container -->
